#!/usr/bin/env ruby

CWD = '%s/.vim/bundle' % ENV['HOME']
Dir.chdir CWD

class Coer

  COUNT = 4

  def initialize
    @q = Queue.new
    @m = Mutex.new
    @c = ConditionVariable.new

    @ts = Array.new(COUNT).map do
      Thread.new do
        loop do
          repo = @q.pop
          break if repo == :die
          co repo
        end
      end
    end
  end

  def enq a
    a.each {|x| @q.push x }
  end

  def co repo
    d = File.join CWD, repo.split('/').last
    if File.exist? d and File.directory? d
      puts 'updating %s...' % repo
      system 'git pull', chdir: d
    else
      system "git clone https://github.com/#{repo}", chdir: CWD
    end
    true
  end

  def die
    @ts.length.times { @q.push :die }
    loop do
      Thread.pass
      break if @ts.all? {|t| !t.alive?}
    end
  end

end

repos = %w[

  vim-ruby/vim-ruby
  rizzatti/dash.vim
  rizzatti/funcoo.vim
  mattn/emmet-vim
  majutsushi/tagbar
  altercation/vim-colors-solarized
  tpope/vim-fugitive
  tpope/vim-markdown
  tpope/vim-repeat
  tpope/vim-surround
  tpope/vim-dadbod
  tpope/vim-rhubarb
  scrooloose/nerdtree
  bling/vim-airline
  pangloss/vim-javascript
  fatih/vim-go
  kien/ctrlp.vim
  NLKNguyen/papercolor-theme
  rking/ag.vim
  scrooloose/syntastic
  AndrewRadev/splitjoin.vim
  elixir-editors/vim-elixir
  chr4/nginx.vim
  fatih/vim-nginx
  digitaltoad/vim-pug
  neo4j-contrib/cypher-vim-syntax
  tpope/vim-commentary
  slashmili/alchemist.vim
]
coer = Coer.new
coer.enq repos
coer.die

__END__
  SirVer/ultisnips
  honza/vim-snippets
  chriskempson/base16-vim
  briancollins/vim-jst
  posva/vim-vue
  hashivim/vim-terraform
  jwalton512/vim-blade
  evidens/vim-twig
