# Database Setup

1. install PostgreSQL
2. install PROJ4
3. install GEOS
4. install PostGIS
5. install memcached
6. install redis

### Installing PostgreSQL database

Download the [source](http://ftp.postgresql.org/pub/source/v9.2.2/postgresql-9.2.2.tar.bz2), extract, then:

```bash
./configure --prefix=/usr/local --with-openssl CFLAGS=-I/usr/local/include LDFLAGS=-L/usr/local/lib
make
sudo make install
sudo mkdir -p /usr/local/pgsql/data
sudo chown -R _postgres /usr/local/pgsql
chsh _postgres
```

Set `_postgres` home directory to `/usr/local/pgsql`, and the shell to `/bin/bash`.

```bash
ln -s /path/to/dotfiles/bin/pg ~/bin/pg
sudo su _postgres
/usr/local/bin/initdb -D /usr/local/pgsql/data
# make sure to exit the _postgres user session
```

Now you can start and stop the PostgreSQL server with `sudo su _postgres pg (start|stop)`

### Installing PROJ4

Download the [package](http://download.osgeo.org/proj/proj-4.8.0.tar.gz), extract, then:

```bash
./configure --prefix=/usr/local --enable-shared
make
sudo make install
```

### Installing PCRE

Download the [package](http://voxel.dl.sourceforge.net/project/pcre/pcre/8.31/pcre-8.31.tar.bz2), extract, then:

```bash
./configure --prefix=/usr/local
make
sudo make install
```

### Installing SWIG

Download the [package](http://hivelocity.dl.sourceforge.net/project/swig/swig/swig-2.0.9/swig-2.0.9.tar.gz), extract, then:

```bash
./configure --prefix=/usr/local
make
sudo make install
```

### Installing GEOS


See the [GCC](GccDevSetup.md) file for instructions on building a new GCC. Then, make sure that compiler comes first in your path:

```bash
export PATH=/opt/gcc/current/bin:$PATH
```

**or use a later clang - like from llvm svn... had to symlink gcc & g++ to clang**

Download the [package](http://download.osgeo.org/geos/geos-3.3.6.tar.bz2), extract, then:

```bash
export CFLAGS='-DHAVE_STRUCT_TIMESPEC -I/opt/ruby/1.9.3-p362/include/ruby-1.9.1'
export CPPFLAGS='-DHAVE_STRUCT_TIMESPEC -I/opt/ruby/1.9.3-p362/include/ruby-1.9.1'
export LDFLAGS='-L/opt/ruby/1.9.3-p362/lib'
./configure --prefix=/usr/local --enable-shared --enable-python --enable-ruby
make
```

In `geos_wrap.cxx` was processed by swig and had a bad struct access on line 7878. ruby 1.8 `RArray` structs had a `len`
member, but 1.9 moved this inside a `heap` struct inside an `as` union. pre-patching doesn't help since the file is
regenerated by swig. So, go find this around line 7878. If you can't find it there, search for `RARRAY` macro usage.

__TODO: revisit this and see if my `swig` was built wrong__

```diff
--- a/swig/ruby/geos_wrap.cxx
+++ b/swig/ruby/geos_wrap.cxx

         /* Get the length */
-        arg3 = RARRAY(argv[1])->len;
+        arg3 = RARRAY(argv[1])->as.heap.len;

         /* Allocate space for the C array. */
```


```bash
make
sudo make install
unset CFLAGS CPPFLAGS LDFLAGS
```

__Remember to reset your PATH__

### Installing GNU gettext

Download the [package](http://ftp.gnu.org/gnu/gettext/gettext-0.18.2.tar.gz), extract, then:

```diff
diff --git a/gettext-tools/gnulib-lib/stpncpy.c b/gettext-tools/gnulib-lib/stpncpy.c
index ca53ebb..b51b688 100644
--- a/gettext-tools/gnulib-lib/stpncpy.c
+++ b/gettext-tools/gnulib-lib/stpncpy.c
@@ -31,7 +31,7 @@
 /* Copy no more than N bytes of SRC to DST, returning a pointer past the
    last non-NUL byte written into DST.  */
 char *
-__stpncpy (char *dest, const char *src, size_t n)
+__stpcpy (char *dest, const char *src, size_t n)
 {
   char c;
   char *s = dest;
```

```bash
./configure --prefix=/usr/local --with-libiconv-prefix=/usr/local --with-ncurses-prefix=/usr/local
make
sudo make install
```

### Installing JSON-C

Clone the github repo and build:

```bash
git clone https://github.com/json-c/json-c.git
cd json-c
./configure --prefix=/usr/local --enable-shared
make
sudo make install
```

### Installing GDAL

First, GDAL depends on some image libraries.

#### Image libraries

* [GIF](http://iweb.dl.sourceforge.net/project/giflib/giflib-5.x/giflib-5.0.2.tar.bz2)



* JPG

```bash
cvs -d:pserver:anonymous@libjpeg.cvs.sourceforge.net:/cvsroot/libjpeg login
cvs -z3 -d:pserver:anonymous@libjpeg.cvs.sourceforge.net:/cvsroot/libjpeg co -P libjpeg
```

* [JasPer](http://www.ece.uvic.ca/~frodo/jasper/software/jasper-1.900.1.zip)



* [PNG](http://iweb.dl.sourceforge.net/project/libpng/libpng15/1.5.13/libpng-1.5.13.tar.xz)
* [TIFF](http://www.remotesensing.org/libtiff/)
* [GeoTIFF](https://svn.osgeo.org/metacrs/geotiff/trunk/libgeotiff) __SVN Repo__

#### Expat XML parser

* [expat](http://iweb.dl.sourceforge.net/project/expat/expat/2.1.0/expat-2.1.0.tar.gz)

```bash
./configure --prefix=/usr/local
make
sudo make install
```

#### GDAL time

Download the [source](http://download.osgeo.org/gdal/gdal-1.9.2.tar.gz), extract, then:

```bash
export ARCHFLAGS='-arch x86_64'
./configure --with-geos=/usr/local/bin/geos-config \
            --with-curl \
            --with-threads \
            --disable-static \
            --without-grass \
            --with-jasper=/usr/local \
            --with-libtiff=/usr/local \
            --with-jpeg=/usr/local \
            --with-gif=/usr/local \
            --with-png=/usr/local \
            --with-geotiff=/usr/local \
            --with-sqlite3=/usr \
            --with-odbc \
            --with-pcraster=internal \
            --with-static-proj4=/usr/local \
            --with-expat=/usr/local \
            --with-pg=/usr/local/bin/pg_config \
            --with-libiconv-prefix=/usr/local \
            --with-libz=/usr/local \
            --with-liblzma=yes \
            CFLAGS='-Os -arch x86_64' \
            CXXFLAGS='-Os -arch x86_64' \
            LDFLAGS='-arch x86_64'
make
sudo make install
```

### Installing PostGIS extensions

Download the [package](http://download.osgeo.org/postgis/source/postgis-2.0.2.tar.gz), extract.

**see http://trac.osgeo.org/postgis/ticket/1694**
**if installing against latest json-c, final link command may need this:**

`configure.ac`:

```diff
36c36
<   SQLPP="${CPPBIN} -traditional-cpp -P"
---
>   SQLPP="${CPPBIN} -traditional-cpp -P -C"
730c730
<          	JSON_LDFLAGS="-L$JSONDIR/lib -ljson"
---
> 		JSON_LDFLAGS="-L$JSONDIR/lib -ljson-c"
749c749
<         JSON_LDFLAGS="-ljson"
---
>         JSON_LDFLAGS="-ljson-c"
```

```bash
./autogen.sh # if you had to modify configure.ac as above
./configure --prefix=/usr/local \
            --with-libiconv-prefix=/usr/local \
            --with-geosconfig=/usr/local/bin/geos-config \
            --with-gettext=/usr/local \
            --with-projdir=/usr/local \
            --with-jsondir=/usr/local \
            --with-raster \
            --with-gdalconfig=/usr/local/bin/gdal-config
make
sudo make install
```

### Installing memcached

#### libevent

Download [libevent](https://github.com/downloads/libevent/libevent/libevent-2.0.20-stable.tar.gz), extract, then:

```bash
./configure --prefix=/usr/local
make
sudo make install
```

#### memcached

Download [memcached](http://memcached.googlecode.com/files/memcached-1.4.15.tar.gz), extract, then:

```bash
./configure --prefix=/usr/local --enable-64bit
make
sudo make install
```

To run: `memcached -d`

### Installing Redis

Download [redis](http://redis.googlecode.com/files/redis-2.6.2.tar.gz), extract, then:

```bash
make
make test
sudo make install
sudo cp redis.conf /usr/local/etc
sudo chown [you] /usr/local/etc/redis.conf
sudo touch /var/log/redis.conf
sudo chown [you] /var/log/redis.conf
```

Edit `/usr/local/etc/redis.conf`, set `daemonize` to `yes`, `loglevel` to whatever you want, and `logfile` to `/var/log/redis.conf`

Clone this git [repo](https://github.com/chris/redis-startupitem-osx.git), and:

```bash
sudo cp -R redis /Library/StartupItems
```

That will make redis launch automatically on startup. To launch it right away, do:

```bash
sudo /Library/StartupItems/redis/redis start
```
